(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{77:function(e,t,i){"use strict";i.r(t),i.d(t,"frontMatter",(function(){return r})),i.d(t,"metadata",(function(){return c})),i.d(t,"rightToc",(function(){return s})),i.d(t,"default",(function(){return b}));var n=i(3),a=i(7),o=(i(0),i(83)),r={id:"fbdevicecontrol",title:"FBDeviceControl"},c={unversionedId:"fbdevicecontrol",id:"fbdevicecontrol",isDocsHomePage:!1,title:"FBDeviceControl",description:"FBDeviceControl is the macOS Framework that implements all functionality associated with iOS Devices within idb. It can be used independently of idb as it is a standalone Framework.",source:"@site/docs/fbdevicecontrol.mdx",slug:"/fbdevicecontrol",permalink:"/docs/fbdevicecontrol",version:"current",sidebar:"docs",previous:{title:"Architecture",permalink:"/docs/architecture"},next:{title:"Commands",permalink:"/docs/commands"}},s=[{value:"<code>MobileDevice.framework</code>",id:"mobiledeviceframework",children:[]},{value:"<code>AMDevice</code>",id:"amdevice",children:[]},{value:"<code>AMRestorableDevice</code>",id:"amrestorabledevice",children:[]},{value:"<code>AMDServiceConnection</code>",id:"amdserviceconnection",children:[]},{value:"<code>AFC</code>: &quot;Apple File Connection&quot;",id:"afc-apple-file-connection",children:[]},{value:"Developer Disk Images",id:"developer-disk-images",children:[]},{value:"Instruments Service",id:"instruments-service",children:[]},{value:"Video Encoding",id:"video-encoding",children:[]}],l={rightToc:s};function b(e){var t=e.components,i=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},l,i,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl")," is the macOS Framework that implements all functionality associated with iOS Devices within ",Object(o.b)("inlineCode",{parentName:"p"},"idb"),". It can be used independently of ",Object(o.b)("inlineCode",{parentName:"p"},"idb")," as it is a standalone Framework."),Object(o.b)("p",null,"This page contains information about the implementation details of how iOS Device access works from macOS."),Object(o.b)("h2",{id:"mobiledeviceframework"},Object(o.b)("inlineCode",{parentName:"h2"},"MobileDevice.framework")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework")," is a System Framework for macOS. It's default location is at ",Object(o.b)("inlineCode",{parentName:"p"},"/System/Library/PrivateFrameworks/MobileDevice.framework/MobileDevice"),". This is a Private Framework, there is no Apple-provided documentation for it. Most of it's API is of the CoreFoundation style, which means that most of it's surface is made up of plain C symbols with ",Object(o.b)("inlineCode",{parentName:"p"},"CF")," objects passed in or out. As such, this makes integration into an Objective-C Framework (like ",Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl"),") relitavely simple, since ",Object(o.b)("inlineCode",{parentName:"p"},"CF")," objects are often ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFDesignConcepts/Articles/tollFreeBridgedTypes.html"}),"Toll-Free Bridged to Objective-C"),"."),Object(o.b)("p",null,"At a first glance, this Framework is difficult to deal with since Private APIs are typically easier to work with if they export Objective-C classes. However, most of the usual patterns around how ",Object(o.b)("inlineCode",{parentName:"p"},"CoreFoundation")," APIs do apply. ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework")," is used extensively across Apple's macOS Applications that interact with iOS Devices (Finder/iTunes, Xcode, Accessibility Inspector, Apple Configurator 2, Photos). If an Application uses an iOS Device on macOS, it is extremely likely to leverage ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework"),"."),Object(o.b)("p",null,'This wealth of "clients" of ',Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework")," has made it possible to understand how each of the API calls work in terms of their inputs and outputs. As a result, ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBAMDefines.h"}),"there's a header that defines all of the calls that ",Object(o.b)("inlineCode",{parentName:"a"},"FBDeviceControl")," uses"),"."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl")," aims to use these APIs as far as possible, ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework"),' is assumed to be the "canonical" way to interact with iOS Devices on macOS. The ',Object(o.b)("inlineCode",{parentName:"p"},"libimobiledevice")," project is essentially a ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://libimobiledevice.org"}),"re-implementation of ",Object(o.b)("inlineCode",{parentName:"a"},"MobileDevice.framework")," that runs on different host operating systems"),". There's also a range of other projects that use ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework")," including ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/samdmarshall/SDMMobileDevice/blob/master/SDM_MD_Tests/MobileDevice.h"}),Object(o.b)("inlineCode",{parentName:"a"},"SDMMobileDevice")),", ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/mountainstorm/MobileDevice"}),Object(o.b)("inlineCode",{parentName:"a"},"MobileDevice"))," and ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/iOSForensics/pymobiledevice"}),Object(o.b)("inlineCode",{parentName:"a"},"pymobiledevice"))," and more."),Object(o.b)("h2",{id:"amdevice"},Object(o.b)("inlineCode",{parentName:"h2"},"AMDevice")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"AMDevice")," is a CF type defined in ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework"),". It is essentially the object that represents a single iOS Device attached to the host. All functions on an ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice")," start with the prefix ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice")," and typically take an ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice")," as the first argument. An ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice")," will only be present if the device is both booted and attached to the host. It cannot be in DFU or Restore mode."),Object(o.b)("p",null,"To operate on an ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice"),', the phone must "trust" the host. You might recognize this as the ',Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://support.apple.com/en-gb/HT202778"}),'"Trust Dialog" that appears when connecting an iOS Device to a Mac'),". Most calls will fail if this trust exchange has not been performed. The Mac maintains a local store of the cryptographic components that are used as part of this trust exchange. This local store means that an iOS Device will not constantly require trust to be authorized every time that the iOS Device is connected to the same host. If this process did not take place, then it would be completely infeasible for iOS Devices to be used in a Continuous Integration environment."),Object(o.b)("p",null,"Since this is such an important component of how to interact with iOS Devices, it is backed by an Objective-C ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBAMDevice.h"}),Object(o.b)("inlineCode",{parentName:"a"},"FBAMDevice"))," class."),Object(o.b)("p",null,"The process of discovering devices is asynchronous, which means that fetching the list of ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice"),"s at a snapshot in time is going to be unreliable. ",Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl")," instead uses an API within ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework")," ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBAMDeviceManager.m#L199"}),"for recieving an ",Object(o.b)("inlineCode",{parentName:"a"},"AMDevice")," instance every time there is a state change")," in the availability of ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice")," instances. This property is also true of Apple's tools that build on top of ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework"),"; ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://mokacoding.com/blog/xcodebuild-destination-options/"}),Object(o.b)("inlineCode",{parentName:"a"},"xcodebuild")," has a ",Object(o.b)("inlineCode",{parentName:"a"},"-destination-timeout")," parameter")," and Apple Configurator's ",Object(o.b)("inlineCode",{parentName:"p"},"cfgutil")," has a ",Object(o.b)("inlineCode",{parentName:"p"},"--timeout"),' parameter since device discovery is delivered asynchronously. You might never notice this in Xcode\'s "Devices and Simulators" window, but it is still there too.'),Object(o.b)("h2",{id:"amrestorabledevice"},Object(o.b)("inlineCode",{parentName:"h2"},"AMRestorableDevice")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"AMRestorableDevice")," is also part of ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework"),", it represents ",Object(o.b)("strong",{parentName:"p"},"any")," iOS Device that is attached to the host and powered on. This includes iOS Devices that are booting, booted or in DFU/Restore mode."),Object(o.b)("p",null,"This API is extremely limited and only exists to describe devices and perform some actions that are only relevant for devices that are not yet in a booted state. This is used to move a booted device to a DFU/Restore state and back out again. It is useful for understanding why a device that appears to be connected may not be represented by an ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice")," instance."),Object(o.b)("p",null,"This is why ",Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl")," can represent a single ",Object(o.b)("inlineCode",{parentName:"p"},"FBDevice")," instance to be backed either or both of an ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice"),"/",Object(o.b)("inlineCode",{parentName:"p"},"AMRestorableDevice"),", for the sake of full observability into connected iOS Devices. ",Object(o.b)("inlineCode",{parentName:"p"},"FBDevice")," instances will also fail appropriately, for instance when attempting to install an Application to an iOS Device that is in DFU/Restore mode."),Object(o.b)("h2",{id:"amdserviceconnection"},Object(o.b)("inlineCode",{parentName:"h2"},"AMDServiceConnection")),Object(o.b)("p",null,'This is another CoreFoundation type that represents a connection to a "lockdown service". In order to get basically anything done on an iOS Device, a connection to service running on the iOS Device is required. There are a huge range of these services for a variety of cases. For example ',Object(o.b)("inlineCode",{parentName:"p"},"com.apple.syslog_relay"),' is a lockdown service that is used for relaying system logs from the iOS Device to the attached host. You might have seen this used in practice within the "Simulators and Devices" window within Xcode. Connections are created via the ',Object(o.b)("inlineCode",{parentName:"p"},"AMDeviceSecureStartService")," call to an ",Object(o.b)("inlineCode",{parentName:"p"},"AMDevice"),", returning an ",Object(o.b)("inlineCode",{parentName:"p"},"AMDServiceConnection")," type."),Object(o.b)("p",null,"There are a number of function calls relevant to this type, dealing with sending and recieving binary data over the connection as if it was a file descriptor. ",Object(o.b)("inlineCode",{parentName:"p"},"AMDServiceConnection"),' can optionally contain a "secure context", which is cryptographic information required for sending data over a TLS\'d connection. This is why it is important to use ',Object(o.b)("inlineCode",{parentName:"p"},"AMDServiceConnection(Send|Recieve)")," instead of raw ",Object(o.b)("inlineCode",{parentName:"p"},"read"),"/",Object(o.b)("inlineCode",{parentName:"p"},"write"),' syscalls, sending unencrypted information over an encrypted transport will mean that the recieving side is incapable of reading the same data. The presence of a "secure context" can be detected at runtime by inspecting the connection value. In more recent iOS versions, some ',Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/commit/ccff041579475e184695b2cefdc952211dbd6342#diff-7147fc58258b69f4ceb58490a56c16ef795741731f0aed05516b44d397d1e4af"}),"services start requiring usage of encrypted IO")," so detection and usage of these calls is very important."),Object(o.b)("p",null,'It is important to stress that this types is just a "Transport" rather than a "Protocol". Each "lockdown service" may have it\'s own very different binary protocol for sending and recieving data. In the simple case of ',Object(o.b)("inlineCode",{parentName:"p"},"com.apple.syslog_relay"),", the service just repeatedly sends text over the connection. Other protocols, for instance those used by Instruments are far more complicated. There is no single Protocol that is used by all lockdown services."),Object(o.b)("p",null,"There is one exception to this, the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBAMDServiceConnection.h#L83"}),'"Plist Protocol"'),". This is implemented in ",Object(o.b)("inlineCode",{parentName:"p"},"AMDServiceConnection(Send|Recieve)Message")," calls. This is common across a range of services, such as the screenshot service and SpringBoard service. It's essentially wiring a length header followed by a binary plist, this is used on both the send and recieve sides."),Object(o.b)("h2",{id:"afc-apple-file-connection"},Object(o.b)("inlineCode",{parentName:"h2"},"AFC"),': "Apple File Connection"'),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"AFC")," is also common throughout the ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework")," API. This is a set of APIs for file manipulation on an iOS Devices. It is another example of a protocol that wraps an ",Object(o.b)("inlineCode",{parentName:"p"},"AMDServiceConnection")," transport. It has a number of functions for dealing with reading, writing, listing directories, moving, copying and deleting files. These operations are performed on the ",Object(o.b)("inlineCode",{parentName:"p"},"AFCConnection")," type."),Object(o.b)("p",null,"On non-jailbroken devices, there is no way of getting an ",Object(o.b)("inlineCode",{parentName:"p"},"AFC")," connection for the entire root filesystem of the Device. Instead, there are different lockdown services corresponding to various containers or sandboxes within the iPhone's operating system. Access to Photos/Media (",Object(o.b)("inlineCode",{parentName:"p"},"com.apple.afc"),"), Application Sandboxes (",Object(o.b)("inlineCode",{parentName:"p"},"AMDeviceCreateHouseArrestService"),") and crash logs (",Object(o.b)("inlineCode",{parentName:"p"},"com.apple.crashreportcopymobile"),") are all examples of ",Object(o.b)("inlineCode",{parentName:"p"},"AFC")," services."),Object(o.b)("h2",{id:"developer-disk-images"},"Developer Disk Images"),Object(o.b)("p",null,"Whilst iOS by default has a number of different services, not all of them are present on the device. In order to augment the iOS Device with additional functionality to an attached macOS host, ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/FBControlCore/Utility/FBDeveloperDiskImage.m"}),'Xcode bundles a "Developer Disk Image"'),"."),Object(o.b)("p",null,"This is a regular ",Object(o.b)("inlineCode",{parentName:"p"},".dmg")," file, which can be opened on macOS. Within this disk image is a number of executables, libraries and ",Object(o.b)("inlineCode",{parentName:"p"},"plist"),"s describing the lockdown services that get added to the iOS Device upon mounting them on the device. ",Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl")," provides an API for manipulating the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/FBDeviceControl/Commands/FBDeviceDeveloperDiskImageCommands.m"}),"disk image manipulation functions in ",Object(o.b)("inlineCode",{parentName:"a"},"MobileDevice.framework")),". It is not possible to mount arbitrary disk image on an iOS Device. Every disk image and it's binaries are signed by Apple. There are also different disk images for different versions of iOS, presumably because the lockdown services interact with APIs that can change over iOS versions."),Object(o.b)("p",null,"The services that are contained within the Developer Disk Image are associated with functionality that is specific to Xcode, Instruments and Accessibility Inspector. This also means that the usage of these services can vary over versions of Xcode (therefore the Disk Images) instead of over iOS versions. As a result, there may be differences in the client-side implementation of the client depending on the protocol version of the service to which the client is communicating."),Object(o.b)("h2",{id:"instruments-service"},"Instruments Service"),Object(o.b)("p",null,'The "Instruments Service", which is a service within the "Developer Disk Image" is a very important one with respect to iOS Device automation. Since ',Object(o.b)("inlineCode",{parentName:"p"},"Instruments.app")," and the ",Object(o.b)("inlineCode",{parentName:"p"},"instruments")," commandline offers a lot of functionality for launching and profiling Applications and iOS Devices, it is integral to tasks such as app launching and process listing on iOS Devices."),Object(o.b)("p",null,"The client-side implementation of this protocol is provided via ",Object(o.b)("inlineCode",{parentName:"p"},"DTXConnectionServices"),", with a ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBInstrumentsClient.h"}),"provisional re-implementation within ",Object(o.b)("inlineCode",{parentName:"a"},"FBDeviceControl")),". There are more details about the makeup of this protocol ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/troybowman/ios_instruments_client"}),"within the ",Object(o.b)("inlineCode",{parentName:"a"},"ios_instruments_client")," project"),"."),Object(o.b)("h2",{id:"video-encoding"},"Video Encoding"),Object(o.b)("p",null,"One of the key features of ",Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl")," is the ability to stream the iPhone's screen to the host over USB. You might be familiar with this within QuickTime's \"Screen Recording\" feature, where you can record video from a connected iOS Device to an ",Object(o.b)("inlineCode",{parentName:"p"},".mp4")," file on your Mac."),Object(o.b)("p",null,"Access to this ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/FBDeviceControl/Video/FBDeviceVideo.m#L38"}),"is provided via ",Object(o.b)("inlineCode",{parentName:"a"},"AVFoundation")),' as a "Capture Device". Usage of "Capture Devices" on macOS also requires that the hosting process (The process using ',Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl"),') has system-level permissions for this on more recent versions of macOS. With a Capture Device for the iOS Device screen, it is then possible to create a "Capture Session" with the device. A "Capture Session" can thent be established, with relevant configuration so that frames are recieved in the most optimal format for the consumer. ',Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl")," recieves frame samples from the device and these samples are either re-encoded or not before being passed on to a stream of data. "),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"FBDeviceControl")," supports writing to an ",Object(o.b)("inlineCode",{parentName:"p"},"mp4")," video file or as a stream of encoded data. For streams of data, these can be passed to other Applications for cases like webRTC or HTTP Live-Streaming."))}b.isMDXComponent=!0},83:function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return h}));var n=i(0),a=i.n(n);function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function c(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(Object(i),!0).forEach((function(t){o(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t){if(null==e)return{};var i,n,a=function(e,t){if(null==e)return{};var i,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||(a[i]=e[i]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(a[i]=e[i])}return a}var l=a.a.createContext({}),b=function(e){var t=a.a.useContext(l),i=t;return e&&(i="function"==typeof e?e(t):c(c({},t),e)),i},p=function(e){var t=b(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},m=a.a.forwardRef((function(e,t){var i=e.components,n=e.mdxType,o=e.originalType,r=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),p=b(i),m=n,h=p["".concat(r,".").concat(m)]||p[m]||d[m]||o;return i?a.a.createElement(h,c(c({ref:t},l),{},{components:i})):a.a.createElement(h,c({ref:t},l))}));function h(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=i.length,r=new Array(o);r[0]=m;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:n,r[1]=c;for(var l=2;l<o;l++)r[l]=i[l];return a.a.createElement.apply(null,r)}return a.a.createElement.apply(null,i)}m.displayName="MDXCreateElement"}}]);
<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.69">
<script src="https://buttons.github.io/buttons.js"></script><title data-react-helmet="true">FBDeviceControl | idb</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="FBDeviceControl | idb"><meta data-react-helmet="true" name="description" content="FBDeviceControl is the macOS Framework that implements all functionality associated with iOS Devices within idb. It can be used independently of idb as it is a standalone Framework."><meta data-react-helmet="true" property="og:description" content="FBDeviceControl is the macOS Framework that implements all functionality associated with iOS Devices within idb. It can be used independently of idb as it is a standalone Framework."><meta data-react-helmet="true" property="og:url" content="https://fbidb.io/docs/fbdevicecontrol"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://fbidb.io/docs/fbdevicecontrol"><link rel="stylesheet" href="/styles.f46bdb2c.css">
<link rel="preload" href="/styles.f84ebf98.js" as="script">
<link rel="preload" href="/runtime~main.bc1cf630.js" as="script">
<link rel="preload" href="/main.b5c86363.js" as="script">
<link rel="preload" href="/1.513414d1.js" as="script">
<link rel="preload" href="/17.a8ef21d7.js" as="script">
<link rel="preload" href="/18.9dc2bb03.js" as="script">
<link rel="preload" href="/935f2afb.ab5aa808.js" as="script">
<link rel="preload" href="/16.4940db5e.js" as="script">
<link rel="preload" href="/c837efb8.115eaee9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">idb</strong></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/overview">Getting Started</a><a class="navbar__item navbar__link" href="/docs/installation">Docs</a><a href="https://github.com/facebook/idb" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">idb</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/overview">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/installation">Docs</a></li><li class="menu__list-item"><a href="https://github.com/facebook/idb" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/overview">Overview</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/guided-tour">Guided Tour</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/architecture">Architecture</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/commands">Commands</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/fbsimulatorcontrol">FBSimulatorControl</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" href="/docs/fbdevicecontrol">FBDeviceControl</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/test-execution">Test Execution</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/accessibility">Accessibility Automation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faqs">Frequently Asked Questions</a></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">FBDeviceControl</h1></header><div class="markdown"><p><code>FBDeviceControl</code> is the macOS Framework that implements all functionality associated with iOS Devices within <code>idb</code>. It can be used independently of <code>idb</code> as it is a standalone Framework.</p><p>This page contains information about the implementation details of how iOS Device access works from macOS.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="mobiledeviceframework"></a><code>MobileDevice.framework</code><a class="hash-link" href="#mobiledeviceframework" title="Direct link to heading">#</a></h2><p><code>MobileDevice.framework</code> is a System Framework for macOS. It&#x27;s default location is at <code>/System/Library/PrivateFrameworks/MobileDevice.framework/MobileDevice</code>. This is a Private Framework, there is no Apple-provided documentation for it. Most of it&#x27;s API is of the CoreFoundation style, which means that most of it&#x27;s surface is made up of plain C symbols with <code>CF</code> objects passed in or out. As such, this makes integration into an Objective-C Framework (like <code>FBDeviceControl</code>) relitavely simple, since <code>CF</code> objects are often <a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFDesignConcepts/Articles/tollFreeBridgedTypes.html" target="_blank" rel="noopener noreferrer">Toll-Free Bridged to Objective-C</a>.</p><p>At a first glance, this Framework is difficult to deal with since Private APIs are typically easier to work with if they export Objective-C classes. However, most of the usual patterns around how <code>CoreFoundation</code> APIs do apply. <code>MobileDevice.framework</code> is used extensively across Apple&#x27;s macOS Applications that interact with iOS Devices (Finder/iTunes, Xcode, Accessibility Inspector, Apple Configurator 2, Photos). If an Application uses an iOS Device on macOS, it is extremely likely to leverage <code>MobileDevice.framework</code>.</p><p>This wealth of &quot;clients&quot; of <code>MobileDevice.framework</code> has made it possible to understand how each of the API calls work in terms of their inputs and outputs. As a result, <a href="https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBAMDefines.h" target="_blank" rel="noopener noreferrer">there&#x27;s a header that defines all of the calls that <code>FBDeviceControl</code> uses</a>.</p><p><code>FBDeviceControl</code> aims to use these APIs as far as possible, <code>MobileDevice.framework</code> is assumed to be the &quot;canonical&quot; way to interact with iOS Devices on macOS. The <code>libimobiledevice</code> project is essentially a <a href="https://libimobiledevice.org" target="_blank" rel="noopener noreferrer">re-implementation of <code>MobileDevice.framework</code> that runs on different host operating systems</a>. There&#x27;s also a range of other projects that use <code>MobileDevice.framework</code> including <a href="https://github.com/samdmarshall/SDMMobileDevice/blob/master/SDM_MD_Tests/MobileDevice.h" target="_blank" rel="noopener noreferrer"><code>SDMMobileDevice</code></a>, <a href="https://github.com/mountainstorm/MobileDevice" target="_blank" rel="noopener noreferrer"><code>MobileDevice</code></a> and <a href="https://github.com/iOSForensics/pymobiledevice" target="_blank" rel="noopener noreferrer"><code>pymobiledevice</code></a> and more.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="amdevice"></a><code>AMDevice</code><a class="hash-link" href="#amdevice" title="Direct link to heading">#</a></h2><p><code>AMDevice</code> is a CF type defined in <code>MobileDevice.framework</code>. It is essentially the object that represents a single iOS Device attached to the host. All functions on an <code>AMDevice</code> start with the prefix <code>AMDevice</code> and typically take an <code>AMDevice</code> as the first argument. An <code>AMDevice</code> will only be present if the device is both booted and attached to the host. It cannot be in DFU or Restore mode.</p><p>To operate on an <code>AMDevice</code>, the phone must &quot;trust&quot; the host. You might recognize this as the <a href="https://support.apple.com/en-gb/HT202778" target="_blank" rel="noopener noreferrer">&quot;Trust Dialog&quot; that appears when connecting an iOS Device to a Mac</a>. Most calls will fail if this trust exchange has not been performed. The Mac maintains a local store of the cryptographic components that are used as part of this trust exchange. This local store means that an iOS Device will not constantly require trust to be authorized every time that the iOS Device is connected to the same host. If this process did not take place, then it would be completely infeasible for iOS Devices to be used in a Continuous Integration environment.</p><p>Since this is such an important component of how to interact with iOS Devices, it is backed by an Objective-C <a href="https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBAMDevice.h" target="_blank" rel="noopener noreferrer"><code>FBAMDevice</code></a> class.</p><p>The process of discovering devices is asynchronous, which means that fetching the list of <code>AMDevice</code>s at a snapshot in time is going to be unreliable. <code>FBDeviceControl</code> instead uses an API within <code>MobileDevice.framework</code> <a href="https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBAMDeviceManager.m#L199" target="_blank" rel="noopener noreferrer">for recieving an <code>AMDevice</code> instance every time there is a state change</a> in the availability of <code>AMDevice</code> instances. This property is also true of Apple&#x27;s tools that build on top of <code>MobileDevice.framework</code>; <a href="https://mokacoding.com/blog/xcodebuild-destination-options/" target="_blank" rel="noopener noreferrer"><code>xcodebuild</code> has a <code>-destination-timeout</code> parameter</a> and Apple Configurator&#x27;s <code>cfgutil</code> has a <code>--timeout</code> parameter since device discovery is delivered asynchronously. You might never notice this in Xcode&#x27;s &quot;Devices and Simulators&quot; window, but it is still there too.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="amrestorabledevice"></a><code>AMRestorableDevice</code><a class="hash-link" href="#amrestorabledevice" title="Direct link to heading">#</a></h2><p><code>AMRestorableDevice</code> is also part of <code>MobileDevice.framework</code>, it represents <strong>any</strong> iOS Device that is attached to the host and powered on. This includes iOS Devices that are booting, booted or in DFU/Restore mode.</p><p>This API is extremely limited and only exists to describe devices and perform some actions that are only relevant for devices that are not yet in a booted state. This is used to move a booted device to a DFU/Restore state and back out again. It is useful for understanding why a device that appears to be connected may not be represented by an <code>AMDevice</code> instance.</p><p>This is why <code>FBDeviceControl</code> can represent a single <code>FBDevice</code> instance to be backed either or both of an <code>AMDevice</code>/<code>AMRestorableDevice</code>, for the sake of full observability into connected iOS Devices. <code>FBDevice</code> instances will also fail appropriately, for instance when attempting to install an Application to an iOS Device that is in DFU/Restore mode.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="amdserviceconnection"></a><code>AMDServiceConnection</code><a class="hash-link" href="#amdserviceconnection" title="Direct link to heading">#</a></h2><p>This is another CoreFoundation type that represents a connection to a &quot;lockdown service&quot;. In order to get basically anything done on an iOS Device, a connection to service running on the iOS Device is required. There are a huge range of these services for a variety of cases. For example <code>com.apple.syslog_relay</code> is a lockdown service that is used for relaying system logs from the iOS Device to the attached host. You might have seen this used in practice within the &quot;Simulators and Devices&quot; window within Xcode. Connections are created via the <code>AMDeviceSecureStartService</code> call to an <code>AMDevice</code>, returning an <code>AMDServiceConnection</code> type.</p><p>There are a number of function calls relevant to this type, dealing with sending and recieving binary data over the connection as if it was a file descriptor. <code>AMDServiceConnection</code> can optionally contain a &quot;secure context&quot;, which is cryptographic information required for sending data over a TLS&#x27;d connection. This is why it is important to use <code>AMDServiceConnection(Send|Recieve)</code> instead of raw <code>read</code>/<code>write</code> syscalls, sending unencrypted information over an encrypted transport will mean that the recieving side is incapable of reading the same data. The presence of a &quot;secure context&quot; can be detected at runtime by inspecting the connection value. In more recent iOS versions, some <a href="https://github.com/facebook/idb/commit/ccff041579475e184695b2cefdc952211dbd6342#diff-7147fc58258b69f4ceb58490a56c16ef795741731f0aed05516b44d397d1e4af" target="_blank" rel="noopener noreferrer">services start requiring usage of encrypted IO</a> so detection and usage of these calls is very important.</p><p>It is important to stress that this types is just a &quot;Transport&quot; rather than a &quot;Protocol&quot;. Each &quot;lockdown service&quot; may have it&#x27;s own very different binary protocol for sending and recieving data. In the simple case of <code>com.apple.syslog_relay</code>, the service just repeatedly sends text over the connection. Other protocols, for instance those used by Instruments are far more complicated. There is no single Protocol that is used by all lockdown services.</p><p>There is one exception to this, the <a href="https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBAMDServiceConnection.h#L83" target="_blank" rel="noopener noreferrer">&quot;Plist Protocol&quot;</a>. This is implemented in <code>AMDServiceConnection(Send|Recieve)Message</code> calls. This is common across a range of services, such as the screenshot service and SpringBoard service. It&#x27;s essentially wiring a length header followed by a binary plist, this is used on both the send and recieve sides.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="afc-apple-file-connection"></a><code>AFC</code>: &quot;Apple File Connection&quot;<a class="hash-link" href="#afc-apple-file-connection" title="Direct link to heading">#</a></h2><p><code>AFC</code> is also common throughout the <code>MobileDevice.framework</code> API. This is a set of APIs for file manipulation on an iOS Devices. It is another example of a protocol that wraps an <code>AMDServiceConnection</code> transport. It has a number of functions for dealing with reading, writing, listing directories, moving, copying and deleting files. These operations are performed on the <code>AFCConnection</code> type.</p><p>On non-jailbroken devices, there is no way of getting an <code>AFC</code> connection for the entire root filesystem of the Device. Instead, there are different lockdown services corresponding to various containers or sandboxes within the iPhone&#x27;s operating system. Access to Photos/Media (<code>com.apple.afc</code>), Application Sandboxes (<code>AMDeviceCreateHouseArrestService</code>) and crash logs (<code>com.apple.crashreportcopymobile</code>) are all examples of <code>AFC</code> services.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="developer-disk-images"></a>Developer Disk Images<a class="hash-link" href="#developer-disk-images" title="Direct link to heading">#</a></h2><p>Whilst iOS by default has a number of different services, not all of them are present on the device. In order to augment the iOS Device with additional functionality to an attached macOS host, <a href="https://github.com/facebook/idb/blob/master/FBControlCore/Utility/FBDeveloperDiskImage.m" target="_blank" rel="noopener noreferrer">Xcode bundles a &quot;Developer Disk Image&quot;</a>.</p><p>This is a regular <code>.dmg</code> file, which can be opened on macOS. Within this disk image is a number of executables, libraries and <code>plist</code>s describing the lockdown services that get added to the iOS Device upon mounting them on the device. <code>FBDeviceControl</code> provides an API for manipulating the <a href="https://github.com/facebook/idb/blob/master/FBDeviceControl/Commands/FBDeviceDeveloperDiskImageCommands.m" target="_blank" rel="noopener noreferrer">disk image manipulation functions in <code>MobileDevice.framework</code></a>. It is not possible to mount arbitrary disk image on an iOS Device. Every disk image and it&#x27;s binaries are signed by Apple. There are also different disk images for different versions of iOS, presumably because the lockdown services interact with APIs that can change over iOS versions.</p><p>The services that are contained within the Developer Disk Image are associated with functionality that is specific to Xcode, Instruments and Accessibility Inspector. This also means that the usage of these services can vary over versions of Xcode (therefore the Disk Images) instead of over iOS versions. As a result, there may be differences in the client-side implementation of the client depending on the protocol version of the service to which the client is communicating.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="instruments-service"></a>Instruments Service<a class="hash-link" href="#instruments-service" title="Direct link to heading">#</a></h2><p>The &quot;Instruments Service&quot;, which is a service within the &quot;Developer Disk Image&quot; is a very important one with respect to iOS Device automation. Since <code>Instruments.app</code> and the <code>instruments</code> commandline offers a lot of functionality for launching and profiling Applications and iOS Devices, it is integral to tasks such as app launching and process listing on iOS Devices.</p><p>The client-side implementation of this protocol is provided via <code>DTXConnectionServices</code>, with a <a href="https://github.com/facebook/idb/blob/master/FBDeviceControl/Management/FBInstrumentsClient.h" target="_blank" rel="noopener noreferrer">provisional re-implementation within <code>FBDeviceControl</code></a>. There are more details about the makeup of this protocol <a href="https://github.com/troybowman/ios_instruments_client" target="_blank" rel="noopener noreferrer">within the <code>ios_instruments_client</code> project</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="video-encoding"></a>Video Encoding<a class="hash-link" href="#video-encoding" title="Direct link to heading">#</a></h2><p>One of the key features of <code>FBDeviceControl</code> is the ability to stream the iPhone&#x27;s screen to the host over USB. You might be familiar with this within QuickTime&#x27;s &quot;Screen Recording&quot; feature, where you can record video from a connected iOS Device to an <code>.mp4</code> file on your Mac.</p><p>Access to this <a href="https://github.com/facebook/idb/blob/master/FBDeviceControl/Video/FBDeviceVideo.m#L38" target="_blank" rel="noopener noreferrer">is provided via <code>AVFoundation</code></a> as a &quot;Capture Device&quot;. Usage of &quot;Capture Devices&quot; on macOS also requires that the hosting process (The process using <code>FBDeviceControl</code>) has system-level permissions for this on more recent versions of macOS. With a Capture Device for the iOS Device screen, it is then possible to create a &quot;Capture Session&quot; with the device. A &quot;Capture Session&quot; can thent be established, with relevant configuration so that frames are recieved in the most optimal format for the consumer. <code>FBDeviceControl</code> recieves frame samples from the device and these samples are either re-encoded or not before being passed on to a stream of data. </p><p><code>FBDeviceControl</code> supports writing to an <code>mp4</code> video file or as a stream of encoded data. For streams of data, these can be passed to other Applications for cases like webRTC or HTTP Live-Streaming.</p></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/fbsimulatorcontrol"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« FBSimulatorControl</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/test-execution"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Test Execution Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#mobiledeviceframework" class="table-of-contents__link"><code>MobileDevice.framework</code></a></li><li><a href="#amdevice" class="table-of-contents__link"><code>AMDevice</code></a></li><li><a href="#amrestorabledevice" class="table-of-contents__link"><code>AMRestorableDevice</code></a></li><li><a href="#amdserviceconnection" class="table-of-contents__link"><code>AMDServiceConnection</code></a></li><li><a href="#afc-apple-file-connection" class="table-of-contents__link"><code>AFC</code>: &quot;Apple File Connection&quot;</a></li><li><a href="#developer-disk-images" class="table-of-contents__link">Developer Disk Images</a></li><li><a href="#instruments-service" class="table-of-contents__link">Instruments Service</a></li><li><a href="#video-encoding" class="table-of-contents__link">Video Encoding</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://discord.gg/SF26Yqw" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Contribute</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/facebook/idb" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="idb" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Facebook, Inc.</div></div></div></footer></div>
<script src="/styles.f84ebf98.js"></script>
<script src="/runtime~main.bc1cf630.js"></script>
<script src="/main.b5c86363.js"></script>
<script src="/1.513414d1.js"></script>
<script src="/17.a8ef21d7.js"></script>
<script src="/18.9dc2bb03.js"></script>
<script src="/935f2afb.ab5aa808.js"></script>
<script src="/16.4940db5e.js"></script>
<script src="/c837efb8.115eaee9.js"></script>
</body>
</html>
(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{78:function(e,t,i){"use strict";i.r(t),i.d(t,"frontMatter",(function(){return r})),i.d(t,"metadata",(function(){return l})),i.d(t,"rightToc",(function(){return s})),i.d(t,"default",(function(){return m}));var n=i(3),a=i(7),o=(i(0),i(83)),r={id:"fbsimulatorcontrol",title:"FBSimulatorControl"},l={unversionedId:"fbsimulatorcontrol",id:"fbsimulatorcontrol",isDocsHomePage:!1,title:"FBSimulatorControl",description:"FBSimulatorControl is the macOS Framework that implements all functionality associated with iOS Simulators within idb. It can be used independently of idb as it is a standalone Framework.",source:"@site/docs/fbsimulatorcontrol.mdx",slug:"/fbsimulatorcontrol",permalink:"/docs/fbsimulatorcontrol",version:"current",sidebar:"docs",previous:{title:"Commands",permalink:"/docs/commands"},next:{title:"FBDeviceControl",permalink:"/docs/fbdevicecontrol"}},s=[{value:"<code>CoreSimulator.framework</code>",id:"coresimulatorframework",children:[]},{value:"<code>simctl</code>",id:"simctl",children:[]},{value:"<code>CoreSimulatorService</code>",id:"coresimulatorservice",children:[]},{value:"<code>SimRuntime</code>",id:"simruntime",children:[]},{value:"<code>launchd_sim</code>",id:"launchd_sim",children:[]},{value:"Device Sets",id:"device-sets",children:[]},{value:"<code>Simulator.app</code>",id:"simulatorapp",children:[]},{value:"Framebuffers via <code>IOSurface</code>",id:"framebuffers-via-iosurface",children:[]},{value:"<code>IndigoHID</code>",id:"indigohid",children:[]},{value:"<code>SimulatorKit.framework</code>",id:"simulatorkitframework",children:[]}],c={rightToc:s};function m(e){var t=e.components,i=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},c,i,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"FBSimulatorControl")," is the macOS Framework that implements all functionality associated with iOS Simulators within ",Object(o.b)("inlineCode",{parentName:"p"},"idb"),". It can be used independently of ",Object(o.b)("inlineCode",{parentName:"p"},"idb")," as it is a standalone Framework."),Object(o.b)("h2",{id:"coresimulatorframework"},Object(o.b)("inlineCode",{parentName:"h2"},"CoreSimulator.framework")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator")," is the Private Framework that is the interface for most Simulator related functionality on macOS. In previous Xcode versions, ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator")," was bundled inside of Xcode, but it is now installed at the System level just like ",Object(o.b)("inlineCode",{parentName:"p"},"MobileDevice.framework"),". It may be upgraded to a newer version as part of the install process of Xcode itself."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator")," is used by Xcode and ",Object(o.b)("inlineCode",{parentName:"p"},"simctl")," as the Framework used to manipulate Simulators. It has Objective-C classes representing a set of Simulators within a directory (",Object(o.b)("inlineCode",{parentName:"p"},"SimDeviceSet")," wrapped by ",Object(o.b)("inlineCode",{parentName:"p"},"FBSimulatorSet"),") and an individual iOS Simulator (",Object(o.b)("inlineCode",{parentName:"p"},"SimDevice"),", wrapped by ",Object(o.b)("inlineCode",{parentName:"p"},"FBSimulator"),'). There is also a Class that behaves a lot like an "entrypoint" to the Framework in ',Object(o.b)("inlineCode",{parentName:"p"},"SimServiceContext"),", this performs initialization of external services and is aware of the various configurations of Simulators that are availabile."),Object(o.b)("h2",{id:"simctl"},Object(o.b)("inlineCode",{parentName:"h2"},"simctl")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"simctl")," is essentially a CLI that exposes iOS Simulator functionality by linking and using ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator"),". This binary is bundled inside of Xcode, and typically addressed via usage of the ",Object(o.b)("inlineCode",{parentName:"p"},"xcrun")," command. ",Object(o.b)("inlineCode",{parentName:"p"},"xcrun")," is essentially a trampoline that addresses binaries that are bundled within Xcode by using the value defined in ",Object(o.b)("inlineCode",{parentName:"p"},"xcode-select")),Object(o.b)("p",null,"The overwhelming majority of Simulator functionality is not implemented in ",Object(o.b)("inlineCode",{parentName:"p"},"simctl"),", it is implemented within ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator")," with ",Object(o.b)("inlineCode",{parentName:"p"},"simctl")," providing an accessible way of using this functionality. Having this behaviour implemented at the Framework level so that ",Object(o.b)("inlineCode",{parentName:"p"},"Simulator.app")," and ",Object(o.b)("inlineCode",{parentName:"p"},"simctl")," behave identically when using their user interfaces."),Object(o.b)("h2",{id:"coresimulatorservice"},Object(o.b)("inlineCode",{parentName:"h2"},"CoreSimulatorService")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," is a user-level daemon that is bootstrapped by any usage of ",Object(o.b)("inlineCode",{parentName:"p"},"SimServiceContext"),", effectively any usage of iOS Simulators will cause this service to be created and launched. This is an XPC service contained within the ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator.framework")," bundle. This service is responsible for starting and managing Simulators."),Object(o.b)("p",null,"When using ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator")," as a client Framework it will transparently communicate with ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService"),". The overwhelming majority of ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator")," APIs that do meaningful work are essentially performing IO to ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService"),", though the asynchronous nature of this work isn't completely consistent. Some ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator")," APIs (for instance those associated with ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/PrivateHeaders/CoreSimulator/SimDevice.h#L75"}),"launching an iOS Application"),") do have asynchronous methods, but others (such as the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/PrivateHeaders/CoreSimulator/SimServiceContext.h#L26"}),"instantiation of a ",Object(o.b)("inlineCode",{parentName:"a"},"SimServiceContext")),") do not. ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," still gets much of it's implementation from ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator.framework"),", touching different areas of the API."),Object(o.b)("p",null,'Having the "work" of iOS Simulators performed within the context of share user daemon is likely due to the needs to synchronize and consolidate state. The service is also an effective caching mechanism for runtime and device profiles. There are a few downsides to this approach. Firstly, ',Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," is effectively a single point of failure. If ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," becomes stuck, or a client of ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator")," exhibits pathological behaviour, then all iOS Simulator functionality on a given host will fail. iOS Simulator functionality will effectively halt until ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," restarts, either by the hung ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," terminating and restarting or via reboot."),Object(o.b)("p",null,"Secondly, the lifecycle of ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," is tied to that of the selected ",Object(o.b)("inlineCode",{parentName:"p"},"Xcode"),". This means that different versions of Xcode cannot be used concurrently on the same host; ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," can only be aware of a single Xcode at any point in time. Switching Xcodes and fetching a new ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," (for instance via a ",Object(o.b)("inlineCode",{parentName:"p"},"simctl")," command) will cause ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService")," to restart, disconnecting existing clients and killing booted Simulators."),Object(o.b)("h2",{id:"simruntime"},Object(o.b)("inlineCode",{parentName:"h2"},"SimRuntime")),Object(o.b)("p",null,"An iOS Simulator Runtime is all of the required components for running an iOS Simulator of a given iOS version. This is a bundle, where the contents closely match the makeup of the files on disk on a physical device. This includes binaries that are compiled for the host architecture (x86_64 in the case of Intel Macs, ARM64 in the case of ARM based Macs) as well as Frameworks. The Frameworks within a SimRuntime match those of iOS, instead of those of the macOS host. There are often subtle differences in the iOS and macOS APIs, even within the same Framework. A single ",Object(o.b)("inlineCode",{parentName:"p"},"SimRuntime")," represents a single iOS version."),Object(o.b)("p",null,"Each version of Xcode is bundled with ",Object(o.b)("inlineCode",{parentName:"p"},"SimRuntime"),'s for the most recent iOS version that is relevant for the Xcode version across iOS, tvOS and watchOS. However, additional iOS Versions can be supported on a given version of Xcode via the "Components" section within ',Object(o.b)("inlineCode",{parentName:"p"},"Xcode.app"),". These bundles are then installed into ",Object(o.b)("inlineCode",{parentName:"p"},"/Library/Developer/CoreSimulator/Profiles/Runtimes")," on the host system. Runtime bundles are backwards, but not forwards compatible. For example, Xcode 11 has support for iOS 13 (the latest iOS version associated with this Xcode version) and earlier versions of iOS, but not for iOS 14."),Object(o.b)("h2",{id:"launchd_sim"},Object(o.b)("inlineCode",{parentName:"h2"},"launchd_sim")),Object(o.b)("p",null,"iOS, like macOS has ",Object(o.b)("inlineCode",{parentName:"p"},"launchd"),' as it\'s "root process" (often PID 1). However, iOS Simulators have their own version of ',Object(o.b)("inlineCode",{parentName:"p"},"launchd")," as a root process. This ",Object(o.b)("inlineCode",{parentName:"p"},"launchd_sim"),' is effectively the "root process" of the iOS Simulator runtime, but not of the macOS host. This ',Object(o.b)("inlineCode",{parentName:"p"},"launchd_sim")," is required by the Simulator OS in order to launch Applications, manage services etc. Each launched iOS Simulator has it's own ",Object(o.b)("inlineCode",{parentName:"p"},"launchd_sim")," process, launched from the ",Object(o.b)("inlineCode",{parentName:"p"},"launchd_sim")," within the ",Object(o.b)("inlineCode",{parentName:"p"},"SimRuntime"),". This also means that processes within this nested ",Object(o.b)("inlineCode",{parentName:"p"},"launchd")," will only see the processes of the iOS Simulator, rather than all of those of the entire host (including other iOS Simulators running on the same host)."),Object(o.b)("p",null,"This ",Object(o.b)("inlineCode",{parentName:"p"},"launchd_sim")," can be interrogated the same as the ",Object(o.b)("inlineCode",{parentName:"p"},"launchd")," of the host, provided that the ",Object(o.b)("inlineCode",{parentName:"p"},"launchctl")," called is spawned within the ",Object(o.b)("inlineCode",{parentName:"p"},"launchd_sim")," of the iOS Simulator."),Object(o.b)("h2",{id:"device-sets"},"Device Sets"),Object(o.b)("p",null,'A Device Set is essentially a directory that contains a number of created iOS Simulators. The "Default Device Set" is located at ',Object(o.b)("inlineCode",{parentName:"p"},"~/Library/Developer/CoreSimulator/Devices"),", this is the device set that is used by ",Object(o.b)("inlineCode",{parentName:"p"},"Xcode.app"),"."),Object(o.b)("p",null,"Custom device sets can be placed at any location on disk. This is useful for isolating the filesystems of created iOS Simulators from each other. For instance, if there are independent processes managing iOS Simulators on the same host it can be worthwhile having each of these processes manage their own device sets to prevent data races."),Object(o.b)("p",null,"There is also an ",Object(o.b)("inlineCode",{parentName:"p"},"XCTestDevices")," directory at ",Object(o.b)("inlineCode",{parentName:"p"},"~/Library/Developer/XCTestDevices"),". This is the set of Simulators that are used by ",Object(o.b)("inlineCode",{parentName:"p"},"xcodebuild"),", distinct from the user interface. This means that ",Object(o.b)("inlineCode",{parentName:"p"},"xcodebuild")," can manage and use it's own set of iOS Simulators, independent of the Xcode UI. This may exist for a similar reasons to why custom device sets are practical for automation scenarios. It would also be a confusing user experience if an iOS Simulator that was being used within ",Object(o.b)("inlineCode",{parentName:"p"},"xcodebuild")," was using an iOS Simulator that a user was using via Xcode when running UI Tests."),Object(o.b)("h2",{id:"simulatorapp"},Object(o.b)("inlineCode",{parentName:"h2"},"Simulator.app")),Object(o.b)("p",null,'This is the "Simulator" Application with which most developers will be familiar with. This Application effectively mirrors the state of launched iOS Simulators within ',Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService"),". It is not an essential part of booting and managing iOS Simulators; iOS Simulators can be booted and used without a ",Object(o.b)("inlineCode",{parentName:"p"},"Simulator.app")," launched for it. This makes using Simulators more practical in automation scenarios where a running macOS Application representing the iOS Simulator is not important or even desirable."),Object(o.b)("p",null,'The Simulator Application will default to showing all iOS Simulators that are within the "Default Device Set". This means that booted iOS Simulators within "Custom Device Sets" will not be displayed within ',Object(o.b)("inlineCode",{parentName:"p"},"Simulator.app"),"."),Object(o.b)("p",null,"The functionality within this Application is largely implemented within ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator.framework")," and ",Object(o.b)("inlineCode",{parentName:"p"},"SimulatorKit.framework"),", with the UI implemented directly within the application itself."),Object(o.b)("h2",{id:"framebuffers-via-iosurface"},"Framebuffers via ",Object(o.b)("inlineCode",{parentName:"h2"},"IOSurface")),Object(o.b)("p",null,"The screen from an iOS Simulator is rendered, regardless of whether there is an iOS Simulator application that is presenting this within a IO. An iOS Simulator can be launched independently of ",Object(o.b)("inlineCode",{parentName:"p"},"Simulator.app"),", since Simulators are kept alive by ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulatorService"),"."),Object(o.b)("p",null,"In order for other Applications (mainly ",Object(o.b)("inlineCode",{parentName:"p"},"Simulator.app"),", but also for video recording within ",Object(o.b)("inlineCode",{parentName:"p"},"simctl"),") to get the iOS Simulator's Framebuffer for rendering, ",Object(o.b)("inlineCode",{parentName:"p"},"CoreSimulator")," can access the ",Object(o.b)("inlineCode",{parentName:"p"},"IOSurface")," of the screen of an iOS Simulator. A Simulator can have many screens, for instance when Simulating CarPlay and the main screen at the same time."),Object(o.b)("p",null,"An ",Object(o.b)("inlineCode",{parentName:"p"},"IOSurface")," is an object that wraps a Framebuffer, with the contents of the Framebuffer being located within GPU memory. This ",Object(o.b)("inlineCode",{parentName:"p"},"IOSurface")," can be read and inspected across process boundaries. The iOS Simulator uses this ",Object(o.b)("inlineCode",{parentName:"p"},"IOSurface")," as the backing Framebuffer for it's view of an iOS Simulator."),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"IOSurface")," objects are also easily convertable to ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/d587458fa2188fbcdd3f71fcbb2a131903cfa5f2/FBSimulatorControl/Framebuffer/FBSimulatorVideoStream.m#L398"}),'"Pixel Buffer" types that are used in video encoding'),". This allows ",Object(o.b)("inlineCode",{parentName:"p"},"FBSimulatorControl")," to implement video encoding of an iOS Simulator's Framebuffer in a way that avoids large copies of bitmap framebuffers on a per-frame basis."),Object(o.b)("h2",{id:"indigohid"},Object(o.b)("inlineCode",{parentName:"h2"},"IndigoHID")),Object(o.b)("p",null,'"Indigo" is a service present in the iOS Simulator that is used inside ',Object(o.b)("inlineCode",{parentName:"p"},"Simulator.app"),' to synthesize "Input Events" that are understood within the iOS Simulator. This service is how clicking on the UI of the ',Object(o.b)("inlineCode",{parentName:"p"},"Simulator.app")," translate into touches within the iOS Simulator."),Object(o.b)("p",null,'This uses "mach" IPC, where data structures are sent over a channel using ',Object(o.b)("inlineCode",{parentName:"p"},"mach_msg_send"),'. These data structures are defined through the "Mach Interface Generator", which get compiled out of the ',Object(o.b)("inlineCode",{parentName:"p"},"Simulator.app")," binary. As such, ",Object(o.b)("inlineCode",{parentName:"p"},"FBSimulatorControl"),"'s understanding of the layout and values in these data structures ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/facebook/idb/blob/master/PrivateHeaders/SimulatorApp/Indigo.h#L40"}),"are understood through reverse engineering"),"."),Object(o.b)("p",null,"The reverse engineering of this protocol, allows ",Object(o.b)("inlineCode",{parentName:"p"},"FBSimulatorControl")," to expose APIs that allow sending of touch events directly to the iOS Simulator without using Accessibility APIs in a UI Test. The combination of video streams and APIs for sending input events allows for the building of applications that expose a remote iOS Simulator."),Object(o.b)("h2",{id:"simulatorkitframework"},Object(o.b)("inlineCode",{parentName:"h2"},"SimulatorKit.framework")),Object(o.b)("p",null,"This is another macOS Framework that is used in iOS Simulator management. This Framework is not installed to the System, it is bundled within Xcode. Instead, this Framework is more used to implement functionality within ",Object(o.b)("inlineCode",{parentName:"p"},"Simulator.app"),"."),Object(o.b)("p",null,"For example, this Framework contains some of the ",Object(o.b)("inlineCode",{parentName:"p"},"Indigo")," client functionality for sending input events."))}m.isMDXComponent=!0},83:function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return u}));var n=i(0),a=i.n(n);function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function l(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(Object(i),!0).forEach((function(t){o(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t){if(null==e)return{};var i,n,a=function(e,t){if(null==e)return{};var i,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||(a[i]=e[i]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(a[i]=e[i])}return a}var c=a.a.createContext({}),m=function(e){var t=a.a.useContext(c),i=t;return e&&(i="function"==typeof e?e(t):l(l({},t),e)),i},d=function(e){var t=m(e.components);return a.a.createElement(c.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},p=a.a.forwardRef((function(e,t){var i=e.components,n=e.mdxType,o=e.originalType,r=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=m(i),p=n,u=d["".concat(r,".").concat(p)]||d[p]||b[p]||o;return i?a.a.createElement(u,l(l({ref:t},c),{},{components:i})):a.a.createElement(u,l({ref:t},c))}));function u(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=i.length,r=new Array(o);r[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:n,r[1]=l;for(var c=2;c<o;c++)r[c]=i[c];return a.a.createElement.apply(null,r)}return a.a.createElement.apply(null,i)}p.displayName="MDXCreateElement"}}]);